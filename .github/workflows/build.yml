name: build

on: [push]

jobs:
  arm64-bcm2711_defconfig:
    
    runs-on: self-hosted
    
    steps:
    - uses: actions/checkout@v1
    - name: make mrproper
      run: make mrproper
    - name: Make build directory
      run: mkdir build
    - name: make bcm2711_defconfig
      run: make O=build/ ARCH=arm64 bcm2711_defconfig
    - name: make
      run: make O=build/ ARCH=arm64
    - name: Make build/modules_install directory
      run: mkdir build/modules_install
    - name: make modules_install
      run: make O=build/ ARCH=arm64 INSTALL_MOD_PATH=modules_install/ modules_install
    - name: Remove hidden files from build
      run: find build/arch/arm64/boot/ -name .\* -delete # we also want to remove every file starting with a dot (.*) from the build directory we upload because they seem to be automatically generated by make and apper to become unnecessary after build. So they only make the archive bigger and are quite confusing and annoying.
    - name: Upload build:boot
      uses: actions/upload-artifact@v1.0.0
      with:
        name: boot
        path: build/arch/arm64/boot
    - name: Remove symbolic links
      run: find -P build/modules_install/ -type l -delete # symbolic links are a problem because actions/upload-artifact@v1.0.0 seems to follow them and therefore tries to upload Kernel source from build/modules_install/lib/modules/{$KERNEL_VERSION}/source which takes a lot of time. Because of that all runs got canceled due to using too much memory.
    - name: Upload build:modules
      uses: actions/upload-artifact@v1.0.0
      with:
        name: modules
        path: build/modules_install
